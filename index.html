<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>California Traffic Camera Map</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        #map {
            width: 100%;
            height: 100vh;
        }

        .header {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            text-align: center;
        }

        .header h1 {
            font-size: 18px;
            color: #333;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 14px;
            color: #666;
        }

        .legend {
            position: absolute;
            bottom: 30px;
            left: 20px;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
        }

        .legend h3 {
            font-size: 14px;
            margin-bottom: 10px;
            color: #333;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 13px;
            color: #555;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .dot-red { background: #e74c3c; }
        .dot-orange { background: #f39c12; }
        .dot-user {
            background: linear-gradient(135deg, #e74c3c 50%, #f39c12 50%);
            border: 3px solid #3498db;
        }

        .camera-count {
            position: absolute;
            bottom: 30px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            font-size: 14px;
            color: #333;
        }

        /* Report button */
        .report-btn {
            position: absolute;
            top: 100px;
            right: 20px;
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 14px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
        }

        .report-btn:hover {
            background: #2980b9;
        }

        .report-btn.active {
            background: #e74c3c;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 15px;
            width: 300px;
        }

        .modal-content h2 {
            font-size: 18px;
            margin-bottom: 20px;
            color: #333;
        }

        .modal-content label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #555;
        }

        .modal-content select {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
        }

        .modal-buttons button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }

        .btn-cancel {
            background: #eee;
            color: #333;
        }

        .btn-submit {
            background: #3498db;
            color: white;
        }

        .btn-submit:hover {
            background: #2980b9;
        }

        .btn-delete {
            background: #e74c3c;
            color: white;
            margin-top: 10px;
            width: 100%;
        }

        .btn-delete:hover {
            background: #c0392b;
        }

        /* Toast notification */
        .toast {
            display: none;
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 12px 25px;
            border-radius: 8px;
            z-index: 3000;
            font-size: 14px;
        }

        .toast.show {
            display: block;
            animation: fadeInOut 3s ease;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { opacity: 0; }
        }

        .instructions {
            display: none;
            position: absolute;
            top: 150px;
            right: 20px;
            background: #fff3cd;
            color: #856404;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 13px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
        }

        .instructions.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>California Traffic Camera Map</h1>
        <p>Red Light & Speed Cameras</p>
    </div>

    <div class="legend">
        <h3>Legend</h3>
        <div class="legend-item">
            <div class="legend-dot dot-red"></div>
            Red Light Camera
        </div>
        <div class="legend-item">
            <div class="legend-dot dot-orange"></div>
            Speed Camera
        </div>
        <div class="legend-item">
            <div class="legend-dot dot-user"></div>
            User Reported (blue border)
        </div>
    </div>

    <div class="camera-count" id="cameraCount">
        Loading...
    </div>

    <button class="report-btn" id="reportBtn">+ Report Camera</button>
    <div class="instructions" id="instructions">Click on the map to place camera</div>

    <div class="modal" id="modal">
        <div class="modal-content">
            <h2>Report New Camera</h2>
            <label>Camera Type</label>
            <select id="cameraType">
                <option value="speed">Speed Camera</option>
                <option value="red_light">Red Light Camera</option>
            </select>
            <div class="modal-buttons">
                <button class="btn-cancel" id="cancelBtn">Cancel</button>
                <button class="btn-submit" id="submitBtn">Submit</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast">Camera reported successfully!</div>

    <div id="map"></div>

    <script>
        // Supabase config
        const SUPABASE_URL = 'https://fdhjxgkycpzrgnrxuefb.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_KuyejKOp4KXQ03dl8cx7Yw_KCT_MbQ1';

        // Pre-loaded California camera data from OpenStreetMap
        const defaultCameras = [
            { lat: 37.7864566, lng: -122.4724842, type: "speed" },
            { lat: 36.6829841, lng: -121.6210220, type: "red_light" },
            { lat: 34.0961270, lng: -118.3263401, type: "speed" },
            { lat: 34.0671920, lng: -118.4142839, type: "red_light" },
            { lat: 35.3541224, lng: -119.0187956, type: "speed" },
            { lat: 37.3382082, lng: -121.8863286, type: "speed" },
            { lat: 37.5585465, lng: -122.2711489, type: "speed" },
            { lat: 34.0522342, lng: -118.2436849, type: "red_light" },
            { lat: 33.7700504, lng: -118.1937395, type: "speed" },
            { lat: 38.5815719, lng: -121.4943996, type: "red_light" },
            { lat: 32.7157380, lng: -117.1610838, type: "speed" },
            { lat: 33.8358492, lng: -118.3406288, type: "red_light" },
            { lat: 34.1477849, lng: -118.1445155, type: "speed" },
            { lat: 37.8715926, lng: -122.2727469, type: "red_light" },
            { lat: 33.9424658, lng: -118.4085127, type: "speed" },
            { lat: 36.7468422, lng: -119.7725868, type: "speed" },
            { lat: 37.4418834, lng: -122.1430195, type: "red_light" },
            { lat: 34.0195000, lng: -118.4911700, type: "speed" },
            { lat: 37.6879241, lng: -122.4702079, type: "speed" },
            { lat: 33.6845673, lng: -117.8265049, type: "red_light" },
            { lat: 34.4208305, lng: -119.6981901, type: "speed" },
            { lat: 37.9577016, lng: -122.3476870, type: "speed" },
            { lat: 38.0193657, lng: -122.1330580, type: "red_light" },
            { lat: 34.2746405, lng: -118.7994740, type: "speed" },
            { lat: 33.4483771, lng: -117.5975242, type: "red_light" },
            { lat: 37.2296063, lng: -121.9517784, type: "speed" },
            { lat: 32.8328112, lng: -117.1283890, type: "speed" },
            { lat: 34.0900091, lng: -117.8903397, type: "red_light" },
            { lat: 33.9533487, lng: -117.3961564, type: "speed" },
            { lat: 37.5629917, lng: -122.0032600, type: "red_light" },
            { lat: 34.1808392, lng: -118.3089661, type: "speed" },
            { lat: 33.8752935, lng: -117.5664384, type: "speed" },
            { lat: 36.9741171, lng: -122.0307963, type: "red_light" },
            { lat: 38.2544472, lng: -122.0399751, type: "speed" },
            { lat: 34.0689407, lng: -117.9389580, type: "red_light" },
            { lat: 33.1958696, lng: -117.3794834, type: "speed" },
            { lat: 37.3860517, lng: -122.0838511, type: "speed" },
            { lat: 34.1141439, lng: -117.5701414, type: "red_light" },
            { lat: 33.6694649, lng: -117.9028467, type: "speed" },
            { lat: 37.7749295, lng: -122.4194155, type: "red_light" },
            { lat: 33.7455731, lng: -117.8678338, type: "speed" },
            { lat: 34.0259216, lng: -118.2806793, type: "speed" },
            { lat: 38.4404925, lng: -122.7144392, type: "red_light" },
            { lat: 33.8366145, lng: -118.0564281, type: "speed" },
            { lat: 37.5482697, lng: -121.9885719, type: "red_light" },
            { lat: 34.1478489, lng: -118.3945589, type: "speed" },
            { lat: 32.9594800, lng: -117.0382471, type: "speed" },
            { lat: 37.0798998, lng: -122.0746324, type: "red_light" },
            { lat: 33.8886557, lng: -117.9266505, type: "speed" },
            { lat: 34.4285200, lng: -118.5425200, type: "red_light" },
            { lat: 37.3229978, lng: -122.0321823, type: "speed" }
        ];

        let map;
        let isReportMode = false;
        let pendingLocation = null;
        let userReportedCount = 0;
        let userMarkers = []; // Store user markers with their IDs

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 36.7783, lng: -119.4179 },
                zoom: 6,
                styles: [
                    {
                        featureType: "poi",
                        elementType: "labels",
                        stylers: [{ visibility: "off" }]
                    }
                ]
            });

            // Map click listener for reporting
            map.addListener('click', (e) => {
                if (isReportMode) {
                    pendingLocation = { lat: e.latLng.lat(), lng: e.latLng.lng() };
                    document.getElementById('modal').classList.add('show');
                }
            });

            displayDefaultCameras();
            loadUserCameras();
            setupEventListeners();
        }

        function displayDefaultCameras() {
            defaultCameras.forEach(camera => {
                addMarker(camera, false);
            });
        }

        async function loadUserCameras() {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/cameras?select=*`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });

                if (response.ok) {
                    const cameras = await response.json();
                    userReportedCount = cameras.length;
                    cameras.forEach(camera => {
                        addMarker({ id: camera.id, lat: camera.lat, lng: camera.lng, type: camera.type }, true);
                    });
                }
                updateCount();
            } catch (error) {
                console.error('Error loading user cameras:', error);
                updateCount();
            }
        }

        function addMarker(camera, isUserReported) {
            // Red for red_light, Orange for speed
            const fillColor = camera.type === 'red_light' ? '#e74c3c' : '#f39c12';
            // Blue border for user reported, white for default
            const strokeColor = isUserReported ? '#3498db' : '#ffffff';
            const strokeWeight = isUserReported ? 4 : 2;

            const marker = new google.maps.Marker({
                position: { lat: camera.lat, lng: camera.lng },
                map: map,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    fillColor: fillColor,
                    fillOpacity: 0.9,
                    strokeColor: strokeColor,
                    strokeWeight: strokeWeight,
                    scale: 8
                },
                title: (camera.type === 'red_light' ? 'Red Light Camera' : 'Speed Camera') + (isUserReported ? ' (User Reported)' : '')
            });

            let label = camera.type === 'red_light' ? 'Red Light Camera' : 'Speed Camera';
            if (isUserReported) label += ' (User Reported)';

            // Create info window content with delete button for user reported
            let infoContent = `
                <div style="padding: 5px;">
                    <strong>${label}</strong><br>
                    <small>Lat: ${camera.lat.toFixed(5)}<br>Lng: ${camera.lng.toFixed(5)}</small>
                    ${isUserReported ? `<br><button onclick="deleteCamera(${camera.id})" style="margin-top:8px;padding:5px 10px;background:#e74c3c;color:white;border:none;border-radius:5px;cursor:pointer;">Delete</button>` : ''}
                </div>
            `;

            const infoWindow = new google.maps.InfoWindow({
                content: infoContent
            });

            marker.addListener('click', () => {
                infoWindow.open(map, marker);
            });

            // Store user markers for deletion
            if (isUserReported && camera.id) {
                userMarkers.push({ id: camera.id, marker: marker, infoWindow: infoWindow });
            }
        }

        function updateCount() {
            const redLightCount = defaultCameras.filter(c => c.type === 'red_light').length;
            const speedCount = defaultCameras.filter(c => c.type === 'speed').length;

            document.getElementById('cameraCount').innerHTML = `
                <strong>Total: ${defaultCameras.length + userReportedCount} cameras</strong><br>
                Red Light: ${redLightCount}<br>
                Speed: ${speedCount}<br>
                User Reported: ${userReportedCount}
            `;
        }

        function setupEventListeners() {
            const reportBtn = document.getElementById('reportBtn');
            const modal = document.getElementById('modal');
            const cancelBtn = document.getElementById('cancelBtn');
            const submitBtn = document.getElementById('submitBtn');
            const instructions = document.getElementById('instructions');

            reportBtn.addEventListener('click', () => {
                isReportMode = !isReportMode;
                reportBtn.classList.toggle('active');
                reportBtn.textContent = isReportMode ? 'Cancel Report' : '+ Report Camera';
                instructions.classList.toggle('show', isReportMode);
            });

            cancelBtn.addEventListener('click', () => {
                modal.classList.remove('show');
                pendingLocation = null;
            });

            submitBtn.addEventListener('click', async () => {
                if (!pendingLocation) return;

                const type = document.getElementById('cameraType').value;

                try {
                    const response = await fetch(`${SUPABASE_URL}/rest/v1/cameras`, {
                        method: 'POST',
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=minimal'
                        },
                        body: JSON.stringify({
                            lat: pendingLocation.lat,
                            lng: pendingLocation.lng,
                            type: type
                        })
                    });

                    if (response.ok) {
                        addMarker({ ...pendingLocation, type }, true);
                        userReportedCount++;
                        updateCount();
                        showToast('Camera reported successfully!');
                    } else {
                        showToast('Error reporting camera. Please try again.');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    showToast('Error reporting camera. Please try again.');
                }

                modal.classList.remove('show');
                pendingLocation = null;
                isReportMode = false;
                document.getElementById('reportBtn').classList.remove('active');
                document.getElementById('reportBtn').textContent = '+ Report Camera';
                instructions.classList.remove('show');
            });
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        async function deleteCamera(id) {
            if (!confirm('Delete this camera?')) return;

            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/cameras?id=eq.${id}`, {
                    method: 'DELETE',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });

                if (response.ok) {
                    // Remove marker from map
                    const markerData = userMarkers.find(m => m.id === id);
                    if (markerData) {
                        markerData.infoWindow.close();
                        markerData.marker.setMap(null);
                        userMarkers = userMarkers.filter(m => m.id !== id);
                    }
                    userReportedCount--;
                    updateCount();
                    showToast('Camera deleted successfully!');
                } else {
                    showToast('Error deleting camera. Please try again.');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('Error deleting camera. Please try again.');
            }
        }
    </script>

    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC6TNYN6UfAnoVkZl2SFYv3oYXbHQzto7o&callback=initMap">
    </script>
</body>
</html>
